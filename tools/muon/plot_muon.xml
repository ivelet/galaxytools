<tool id="plot_muon" name="Plot with muon" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
mdata = mu.read_h5mu('$mudata_input')

#if $method.method == "embedding"
embeddings_plot = mu.pl.embedding(
    mdata,
    basis='$method.embedding_basis',
    color='$method.embedding_color',
    use_raw='$method.embedding_use_raw',
    layer='$method.embedding_layer',
    return_fig=True
)

#else if $method.method == "mofa"
#set $mofa_components = ([x.strip() for x in str($mofa_components).split('.')])
mofa_plot = mu.pl.mofa(
    mdata,
    color='$method.mofa_color',
    components='$method.mofa_components',
    return_fig=True
)
mofa_plot.savefig("plot.png")

#else if $method.method == "scatter"
scatter_plot = mu.pl.scatter(
    mdata,
    x='$method.scatter_x',
    y='$method.scatter_y',
    color='$method.scatter_color',
    use_raw='$method.scatter_use_raw',
    layers='$method.use_layers',
    return_fig=True
)
scatter_plot.savefig("plot.png")

#else if $method.method == "umap"
umap_plot = mu.pl.umap(
    mdata,
    return_fig=True
)
umap_plot.savefig("plot.png")

#else if $method.method == "histogram"
histogram_plot = mu.pl.histogram(
    mdata,
    keys='$method.histogram_keys',
    groupby='$method.histogram_groupby',
    return_fig=True
)
histogram_plot.savefig("plot.png")

#else if $method.method == "mofa_loadings"
mofa_loadings_plot = mu.pl.mofa_loadings(
    mdata,
    factors='$method.mofa_loadings_factors',
    include_lowest='$method.mofa_loadings_include_lowest',
    n_points='$method.mofa_loadings_n_points',
    return_fig=True
)
mofa_loadings_plot.savefig("plot.png")
#end if
]]></configfile>
    </configfiles>
    <inputs>
        <param name="mudata_input" type="data" format="h5mu" label="MuData input for plotting" help="(.h5mu)"/>
        <conditional name="method">
            <param argument="method" type="select" label="Method used for plotting">
                    <option value="embedding">Scatter: Scatter plot along observations (.obs column), using 'muon.pl.embedding'</option>
                    <option value="mofa">Scatter: Scatter plot in MOFA factor coordinates, using 'muon.pl.mofa'</option>
                    <option value="scatter">Scatter: Scatter plot along observations or variable axes, using 'muon.pl.scatter'</option>
                    <option value="umap">Scatter: UMAP scatter plot, using 'muon.pl.umap'</option>
                    <option value="histogram">Histogram: Plot Histogram of Fragment lengths within specified region, using 'muon.pl.histogram'</option>
                    <option value="mofa_loadings">Ranking: Rank genes according to contributions to MOFA factors, using 'muon.pl.mofa_loadings'</option>
            </param>
            <when value="embedding">
                <param name="embedding_basis" type="text" label="Name of the obsm basis to use" help="(basis)"/>
                <param name="embedding_color" type="text" label="Keys for variables or annotations of observations (.obs columns). Can be from any modality." help="(color)"/>
                <param name="embedding_use_raw" type="boolean" label="Use .raw attribute of the modality where a feature (from color) is derived from" help="(use_raw)"/>
                <param name="embedding_layer" type="text" label="Name of the layer in the modality where a feature (from color) is derived from" help="(layer)"/>
            </when>
            <when value="mofa">
                <param name="mofa_color" type="text" label="Colors to use when plotting" help="(color)"/>
                <param name="mofa_components" type="text" label="Components to use when plotting" help="(components), should be dot-separated e.g. '1,2. 3,4'"/>
            </when>
            <when value="scatter">
                <param name="scatter_x" type="text" label="X-coordinate" help="(x)"/>
                <param name="scatter_y" type="text" label="Y-coordinate" help="(y)"/>
                <param name="scatter_color" type="text" label="Keys for variables or annotations of observations (.obs columns), or a hex colour specification" help="(color)"/>
                <param name="scatter_use_raw" type="boolean" label="Use raw (.raw attribute of the modality where a feature (from color) is derived from)" help="(use_raw)"/>
                <param name="scatter_layers" type="text" label="Names of the layers where x, y, and color come from" help="(layers)"/>
            </when>
            <when value="umap">
            </when>
            <when value="histogram">
                <param name="histogram_keys" type="text" label="Keys to plot" help="(keys)"/>
                <param name="histogram_group_by" type="text" label="Column name(s) of .obs slot of the AnnData object according to which the plot is split" help="(groupby)"/>
            </when>
            <when value="mofa_loadings">
                <param name="mofa_loadings_factors" type="text" label="For example, '1,2,3' means [1, 2, 3], first, second, third factors" help="(factors)"/>
                <param name="mofa_loadings_include_lowest" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Whether to show the variables with both highest and lowest loadings" help="(include_lowest)"/>
                <param name="mofa_loadings_n_points" type="integer" label="Number of variables to plot for each factor" help="(n_points)"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="plot" format="png" label="Plot" from_work_dir="plot.png"/>
    </outputs>
    <tests>
        <test>
            <!--Test for muon.pl.embedding()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="embedding"/>
            <param name="embedding_basis"/>
            <param name="embedding_color"/>
            <param name="embedding_use_raw"/>
            <param name="embedding_layer"/>
            <output name="plot" file="plot.png"/>
        </test>
        <test>
            <!--Test for muon.pl.mofa()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="mofa"/>
            <param name="color" value="rna:celltype"/>
            <param name="components" value="1,2 . 3,4"/>
            <output name="plot" file="plot.png"/>
            <!--Test for muon.pl.scatter()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="scatter"/>
            <param name="scatter_x" value="None"/>
            <param name="scatter_y" value="None"/>
            <param name="scatter_color" value="None"/>
            <param name="scatter_use_raw" value="None"/>
            <param name="scatter_layers" value="None"/>
            <output name="plot" file="plot.png"/>
            <!--Test for muon.pl.umap()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="umap"/>
            <output name="plot" file="plot.png"/>
            <!--Test for muon.pl.histogram()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="histogram"/>
            <param name="histogram_keys" value="total_counts"/>
            <param name="histogram_group_by" value="None"/>
            <output name="plot" file="plot.png"/>
            <!--Test for muon.pl.mofa_loadings()-->
            <param name="mudata_input" value="mudata_input.h5ad"/>
            <param name="method" value="mofa_loadings"/>
            <param name="mofa_loadings_factors" value="1"/>
            <param name="mofa_loadings_include_lowest" value="True"/>
            <param name="mofa_loadings_n_points" value="0"/>
            <output name="plot" file="plot.png"/>
        </test>
    </tests>
    <help><![CDATA[
        Scatter: Scatter plot along observations (.obs column) ('muon.pl.embedding')
        ============================================================================

        Produce a scatter plot in the define basis (.obs), which can also be a basis inside any modality.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.embedding.html#muon.pl.embedding>`__

        Scatter: Scatter plot in MOFA factor coordinates ('muon.pl.mofa')
        =================================================================

        Scatter plot in MOFA factors coordinates.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.mofa.html#muon.pl.mofa>`__

        Scatter: Scatter plot along observations or variable axes ('muon.pl.scatter')
        =============================================================================

        Scatter plot along observations or variables axes. Variables in each modality can be referenced.

        More details on the 'muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.scatter.html#muon.pl.scatter>`__

        Scatter: UMAP scatter plot ('muon.pl.umap')
        ===========================================

        UMAP Scatter plot.

        More details on the 'muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.umap.html#muon.pl.umap>`__

        Histogram: Plot Histogram of Fragment lengths within specified region ('muon.pl.histogram')
        ===========================================================================================

        Plot Histogram of Fragment lengths within specified region.

        More details on the 'muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.histogram.html#muon.pl.histogram>`__

        Ranking: Rank genes according to contributions to MOFA factors ('muon.pl.mofa_loadings')
        ========================================================================================

        Rank genes according to contributions to MOFA factors.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.mofa_loadings.html#muon.pl.mofa_loadings>`__
    ]]></help>
    <citations>
    </citations>
</tool>