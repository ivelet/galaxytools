<tool id="assign_cell_type_labels" name="Assign Cell Type Labels for ATAC-seq Data" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.1.2">muon</requirement>
        <requirement type="package" version="3.5.3">matplotlib</requirement>
        <requirement type="package" version="1.23">numpy</requirement>
        <requirement type="package" version="0.5">umap</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import umap.plot

atac = sc.read_h5ad("$atac_input")
#set $new_cluster_names_keys = ([x.strip() for x in str($new_cluster_names_keys).split(',')])
#set $new_cluster_names_values = ([x.strip() for x in str($new_cluster_names_values).split(',')])
new_cluster_names = dict(zip($new_cluster_names_keys, $new_cluster_names_values))
atac.obs['celltype'] = atac.obs.leiden.astype("str").values
atac.obs.celltype = atac.obs.celltype.astype("category").cat.rename_categories(new_cluster_names)

#set $reorder_cat_list = ([x.strip() for x in str($reorder_cat_list).split(',')])
reorder_cat_list = $reorder_cat_list
atac.obs.celltype.cat.reorder_categories(reorder_cat_list, inplace=True)

cmap = plt.get_cmap('$get_cmap_name')
colors = cmap(np.linspace(0, 1, len(atac.obs.celltype.cat.categories)))
atac.uns["celltype_colors"] = list(map(matplotlib.colors.to_hex, colors))

atac.write("atac_with_new_labels.h5ad")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="atac_input" type="data" format="h5ad" label="ATAC Input"/>
        <param name="new_cluster_names_keys" type="text" label="New Cluster Names Keys" help="Add the keys of the new clsuter names as numbers separated by commas" value="1, 2, 3, 5, 8, 12, 9, 6, 0, 4, 7, 11, 13"/>
        <param name="new_cluster_names_values" type="text" label="New Cluster Names Values" help="Add the corresponding values to the previously added keys (in the same order and for every key added)" value="CD4+ memory T, CD8+ naïve T, CD4+ naïve T, CD8+ activated T, NK, MAIT, naïve B, memory B, intermediate mono, CD14 mono, CD16 mono, mDC, pDC"/>
        <param name="reorder_cat_list" type="text" label="Categories to reorder" help="Add the names of the categories to reorder, ensuring the same names as previously defined are used." value="CD4+ naïve T, CD4+ memory T, MAIT, CD8+ naïve T, CD8+ activated T, NK, naïve B, memory B, CD14 mono, intermediate mono, CD16 mono, mDC, pDC"/>
        <param name="get_cmap_name" type="text" label="Name of the colormap instance" help="(name in matplotlib.cm.get_cmap()" value="rainbow"/>
    </inputs>
    <outputs>
        <data name="atac_with_new_labels" format="h5ad" label="ATAC with Assigned Celltype Labels"
              from_work_dir="atac_with_new_labels.h5ad"/>
    </outputs>
    <tests>
        <test>
            <param name="atac_input" value="atac_data_tiny.h5ad"/>
            <param name="new_cluster_names_keys" value="13"/>
            <param name="new_cluster_names_values" value="pDC"/>
            <param name="reorder_cat_list" value="pDC"/>
            <param name="get_cmap_name" value="rainbow"/>
            <output name="atac_with_new_labels" value="atac_with_new_labels.h5ad"/>
        </test>
    </tests>
    <help><![CDATA[
    This tool allows the assigning of new celltype labels to ATAC-seq data and then returns the updated AnnData file.
    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>