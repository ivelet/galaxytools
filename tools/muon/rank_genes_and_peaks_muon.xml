<tool id="rank_genes_and_peaks_muon" name="Rank and List Genes and Peaks in Multimodal Data with Scanpy" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
from muon import atac as ac
import pandas as pd
mdata = mu.read_h5mu('$rna_atac_input')
mdata['rna'].obs['leiden_joint'] = mdata.obs.leiden_joint
mdata['atac'].obs['leiden_joint'] = mdata.obs.leiden_joint
sc.tl.rank_genes_groups(mdata['rna'], 'leiden_joint', method='t-test_overestim_var')
ac.tl.rank_peaks_groups(mdata['atac'], 'leiden_joint', method='t-test_overestim_var')
result = {}
result['rna'] = mdata['rna'].uns['rank_genes_groups']
result['rna']['genes'] = result['rna']['names']
result['atac'] = mdata['atac'].uns['rank_genes_groups']
groups = result['rna']['names'].dtype.names
pd.set_option("display.max_columns", 200)
differential_list = pd.DataFrame(
    {mod + ':' + group + '_' + key[:1]: result[mod][key][group][:10]
    for group in groups for key in ['names', 'genes', 'pvals']
    for mod in mdata.mod.keys()})
mdata.write("ranked_rna_atac.h5mu")
differential_list.to_csv('differentially_expressed_genes_accessible_peaks.csv')
]]></configfile>
    </configfiles>
    <inputs>
        <param name="rna_atac_input" type="data" format="h5mu" label="RNA ATAC Clustered Multimodal Data"/>
    </inputs>
    <outputs>
        <data name="ranked_rna_atac" format="h5mu" label="RNA ATAC with Ranked Genes and Peaks" from_work_dir="ranked_rna_atac.h5mu"/>
        <data name="differentially_expressed_genes_accessible_peaks" format="csv"
              label="Differentially Expressed Genes and Accessible Peaks"
              from_work_dir="differentially_expressed_genes_accessible_peaks.csv"/>
    </outputs>
    <tests>
        <test>
            <param name="rna_atac_input" value="rna_atac.h5mu"/>
            <output name="ranked_rna_atac" file="ranked_rna_atac.h5mu"/>
            <output name="differentially_expressed_genes_accessible_peaks" file="differentially_expressed_genes_accessible_peaks.csv"/>
        </test>
    </tests>
    <help><![CDATA[
    **What it does**
        This tool defines cell types based on multiple omics as stored in a MuData file. It then ranks genes of the RNA
        modality and peaks of the ATAC modality using ScanPy's tl.rank_genes_groups and ac.rank_peaks_group.

        It then lists the differentially expressed genes of the RNA modality and the differentially accessible peaks
        of the ATAC modality.

        This tool returns the MuData matrix after this has been done and added to it as a h5mu file and the list as a
        csv file.

    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>