<tool id="mofa" name="Multi Omics Factorial Analysis with Muon" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
mdata = mu.read_h5mu('$rna_atac_input')
mu.tl.mofa(mdata, gpu_mode=True)
sc.pp.neighbors(mdata, use_rep="X_mofa")
sc.tl.umap(mdata)
umap_plot = sc.pl.umap(mdata, return_fig=True)
umap_plot.savefig("mofa_umap_plot.png")
mdata.uns = mdata.uns or dict()
celltype_colors_rna = '$first_mod_name' + ':' + '$celltype_colors'
celltype_colors_atac = '$second_mod_name' + ':' + '$celltype_colors'
mdata.uns[celltype_colors_rna] = mdata['$first_mod_name'].uns['$celltype_colors']
mdata.uns[celltype_colors_atac] = mdata['$second_mod_name'].uns['$celltype_colors']
#set $mofa_plot_components = ([x.strip() for x in str($mofa_plot_components).split('.')])
colors_rna = '$first_mod_name' + ':' + '$first_mod_annotation_name'
colors_atac = '$second_mod_name' + ':' + '$second_mod_annotation_name'
first_mod_plot = mu.pl.mofa(mdata, color=colors_rna, components=$mofa_plot_components, return_fig=True)
second_mod_plot = mu.pl.mofa(mdata, color=colors_atac, components=$mofa_plot_components, return_fig=True)
first_mod_plot.savefig("rna_mofa_annotation.png")
second_mod_plot.savefig("atac_mofa_annotation.png")
mdata.write("rna_atac_integration.h5mu")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="rna_atac_input" type="data" format="h5mu" label="RNA ATAC Multimodal Data Matrix"/>
        <param name="first_mod_name" type="text" label="Name of the first modality" value="rna"/>
        <param name="second_mod_name" type="text" label="Name of the second modality" value="atac"/>
        <param name="celltype_colors" type="text" label="Name of the color for each modality" value="celltype_colors" help="should be stored in mdata.uns[] for your MuData file"/>
        <param name="first_mod_annotation_name" type="text" label="Cell type annotation color of first modality" value="celltype" help="(color in muon.pl.mofa())"/>
        <param name="second_mod_annotation_name" type="text" label="Cell type annotation name of second modality" value="celltype" help="(color in muon.pl.mofa())"/>
        <param name="mofa_plot_components" type="text" label="Components to plot" value="1,2 . 3,4" help="(components in muon.pl.mofa()), should be dot-separated"/>
    </inputs>
    <outputs>
        <data name="rna_atac_integration" format="h5mu" label="Mofa MuData" from_work_dir="rna_atac_integration.h5mu"/>
        <data name="umap_plot" format="png" label="MOFA UMAP Plot" from_work_dir="mofa_umap_plot.png"/>
        <data name="rna_mofa_annotations" format="png" label="RNA MOFA Annotations" from_work_dir="rna_mofa_annotation.png"/>
        <data name="atac_mofa_annotations" format="png" label="ATAC MOFA Annotations" from_work_dir="atac_mofa_annotation.png"/>
    </outputs>
    <tests>
        <test>
            <param name="rna_atac_input" value="rna_atac.h5mu"/>
            <output name="rna_atac_integration" file="rna_atac_integration.h5mu"/>
            <output name="umap_plot" file="mofa_umap_plot.png"/>
            <output name="rna_mofa_annotations" file="rna_mofa_annotation.png"/>
            <output name="atac_mofa_annotations" file="atac_mofa_annotation.png"/>
        </test>
    </tests>
    <help><![CDATA[
    **What it does**
        This tool performs multi omics factor analysis using muon.tl.mofa() on a h5mu matrix containing multimodal data.

        Multi-omic factor analysis (MOFA) is a group factor analysis method that allows to learn an interpretable latent
        space jointly on multiple modalities.

        Intuitively, it can be viewed as a generalization of PCA for multi-omics data.
    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>