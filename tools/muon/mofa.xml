<tool id="mofa" name="Multi Omics Factorial Analysis with Muon" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.1.2">muon</requirement>
        <requirement type="package" version="1.2.0">mofapy</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[pip install mofapy2
       && pip install mofax
       && python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
import mofax as mfx
import numpy as np
mdata = mu.read_h5mu('$mofa_input')

#if $load_mofax_model.load_mofax_model == False
mu.tl.mofa(mdata, outfile="mofa_model_out.hdf5", n_factors=$mofa_n_factors)

#else if $load_mofax_model.load_mofax_model == True
model = mfx.mofa_model('$load_mofax_model.mofax_model')
mdata.obsm["X_mofa"] = model.get_factors()
w = model.get_weights()
model.close()
#end if

mdata.write("mofa_out.h5mu")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="mofa_input" type="data" format="h5mu" label="RNA ATAC Multimodal Data Matrix"/>
        <conditional name="load_mofax_model">
            <param argument="load_mofax_model" type="select" label="Load a trained mofax model?" value="False" help="Set yes if you would like to load a trained mofax model as a hdf5 file, no to train one from scratch">
                    <option value="True">Yes</option>
                    <option value="False">No</option>
            </param>
            <when value="True">
                <param name="mofax_model" type="data" format="hdf5" label="Trained mofax model to use for MOFA"/>
            </when>
            <when value="False">
                <param name="mofa_n_factors" type="integer" label="Number of factors to train the MOFA model with" value="10" help="(n_factors in muon.tl.mofa()), ignored if loading trained model"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="mofa_out" format="h5mu" label="MOFA MuData" from_work_dir="mofa_out.h5mu"/>
        <data name="mofa_model_out" format="hdf5" label="MOFA Model" from_work_dir="mofa_model_out.hdf5"/>
    </outputs>
    <tests>
        <test>
            <!--Test to train a MOFA model from scratch-->
            <param name="mofa_input" value="rna_atac_input.h5mu"/>
            <param name="load_mofax_model" value="False"/>
            <param name="mofa_n_factors" value="10"/>
            <output name="mofa_out" file="mofa_out.h5mu"/>
            <output name="mofa_model_out" file="mofa_model_out.hdf5"/>
        </test>
        <test>
<!--            Test to use an existing MOFA model-->
            <param name="mofa_input" value="rna_atac_input.h5mu"/>
            <param name="load_mofax_model" value="True"/>
            <param name="mofax_model" value="mofa_model_out.hdf5"/>
            <output name="mofa_out" file="mofa_out.h5mu"/>
            <output name="mofa_model_out" file="mofa_model_out.hdf5"/>
        </test>
    </tests>
    <help><![CDATA[
    **What it does**
        This tool performs multi omics factor analysis using muon.tl.mofa() on a h5mu matrix containing multimodal data
        and then plots the MOFA embeddings using muon.pl.mofa().

        Multi-omic factor analysis (MOFA) is a group factor analysis method that allows to learn an interpretable latent
        space jointly on multiple modalities.

        Intuitively, it can be viewed as a generalization of PCA for multi-omics data.

        This tool allows you to use an existing trained mofa model or to train one from scratch and then save the model
        to use it next time and save processing time.
    ]]></help>
    <citations>
        <citation type="doi">10.1186/s13059-021-02577-8</citation>
    </citations>
</tool>