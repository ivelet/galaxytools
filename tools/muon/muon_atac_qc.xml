<tool id="muon_atac_qc" name="ATAC quality control with muon" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.7.0">scanpy</requirement>
        <requirement type="package" version="0.1.2">muon</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        python '$script_file'
]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[import scanpy as sc
import muon as mu
atac = sc.read_h5ad("$atac_input")

$if $method.method == "nucleosomal_signal"
atac.obs['NS']=1
ac.pl.fragment_histogram(atac, region='chr1:1-2000000')
ac.tl.nucleosome_signal(atac, n=1e6)
plot = mu.pl.histogram(atac, "nucleosome_signal", kde=False, return_fig=True)
plot.savefig("plot.png")

$else if $method.method == "tss_enrichment"
ac.tl.get_gene_annotation_from_rna(mdata['rna']).head(3)
tss = ac.tl.tss_enrichment(mdata, n_tss=1000)
plot = ac.pl.tss_enrichment(tss, return_figure=True)
plot.savefig("plot.png")

$end if

atac.write("atac_with_quality_control.h5ad")
]]></configfile>
    </configfiles>
    <inputs>
        <param name="atac_input" type="data" format="h5ad" label="ATAC Input" help="(.h5ad)"/>
        <conditional name="method">
                <param argument="method" type="select" label="Method used for inspecting">
                    <option value="nucleosomal_signal">Compute the ratio of nucleosomal cut fragments to nucleosome-free fragments per cell, using 'atac.tl.nucleosomal_signal'</option>
                    <option value="tss_enrichment">Calculate TSS enrichment according to ENCODE guidelines, using 'atac.tl.tss_enrichment'</option>
                </param>
        </conditional>
    </inputs>
    <outputs>
        <data name="atac_with_quality_control" format="h5ad" label="ATAC with quality control" from_work_dir="atac_with_quality_control.h5ad"/>
    </outputs>
    <tests>
        <test>
            <param name="atac_input" value="atac_input.h5ad"/>
            <output name="atac_with_quality_control" file="atac_with_quality_control.h5ad"/>
        </test>
    </tests>
    <help><![CDATA[


    ]]></help>
    <citations>
        <citation type="bibtex">
}</citation>
    </citations>
</tool>